name: Performance Benchmark

# ä»…æ”¯æŒæ‰‹åŠ¨è§¦å‘ï¼Œä»…åœ¨ net10 åˆ†æ”¯å¯ç”¨
on:
  workflow_dispatch:

env:
  DOTNET_CLI_TELEMETRY_OPTOUT: true
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_NOLOGO: true

jobs:
  benchmark:
    name: Run Performance Benchmarks
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: net10
      
      # å®‰è£…æ€§èƒ½æµ‹è¯•æ‰€éœ€çš„ .NET SDK ç‰ˆæœ¬
      - name: Setup .NET Core 3.1
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '3.1.x'
      
      - name: Setup .NET 5.0
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '5.0.x'
      
      - name: Setup .NET 8.0
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'
      
      - name: Setup .NET 10.0
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'
      
      # éªŒè¯ SDK å®‰è£…
      - name: Display .NET info
        run: dotnet --info
      
      - name: List installed SDKs
        run: dotnet --list-sdks
      
      # ç¼“å­˜ NuGet åŒ…
      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-
      
      # æ¢å¤ä¾èµ–
      - name: Restore dependencies
        run: dotnet restore
      
      # ç¼–è¯‘ Benchmarks é¡¹ç›®
      - name: Build Benchmarks project
        run: dotnet build WebApiClientCore.Benchmarks/WebApiClientCore.Benchmarks.csproj --configuration Release --no-restore
      
      # æ‰§è¡Œ netcoreapp3.1 æ€§èƒ½æµ‹è¯•
      - name: Run benchmarks on netcoreapp3.1
        run: |
          dotnet run --project WebApiClientCore.Benchmarks/WebApiClientCore.Benchmarks.csproj --configuration Release --framework netcoreapp3.1 --no-build -- --filter '*' --exporters json --artifacts ./BenchmarkDotNet.Artifacts.netcoreapp3.1
          # å¤åˆ¶ç»“æœåˆ°æ ‡å‡†ä½ç½®
          if [ -d "BenchmarkDotNet.Artifacts/results" ]; then
            mkdir -p BenchmarkDotNet.Artifacts.netcoreapp3.1
            cp -r BenchmarkDotNet.Artifacts/results BenchmarkDotNet.Artifacts.netcoreapp3.1/
          fi
        continue-on-error: true
      
      # æ‰§è¡Œ net5.0 æ€§èƒ½æµ‹è¯•
      - name: Run benchmarks on net5.0
        run: |
          dotnet run --project WebApiClientCore.Benchmarks/WebApiClientCore.Benchmarks.csproj --configuration Release --framework net5.0 --no-build -- --filter '*' --exporters json --artifacts ./BenchmarkDotNet.Artifacts.net5.0
          if [ -d "BenchmarkDotNet.Artifacts/results" ]; then
            mkdir -p BenchmarkDotNet.Artifacts.net5.0
            cp -r BenchmarkDotNet.Artifacts/results BenchmarkDotNet.Artifacts.net5.0/
          fi
        continue-on-error: true
      
      # æ‰§è¡Œ net8.0 æ€§èƒ½æµ‹è¯•
      - name: Run benchmarks on net8.0
        run: |
          dotnet run --project WebApiClientCore.Benchmarks/WebApiClientCore.Benchmarks.csproj --configuration Release --framework net8.0 --no-build -- --filter '*' --exporters json --artifacts ./BenchmarkDotNet.Artifacts.net8.0
          if [ -d "BenchmarkDotNet.Artifacts/results" ]; then
            mkdir -p BenchmarkDotNet.Artifacts.net8.0
            cp -r BenchmarkDotNet.Artifacts/results BenchmarkDotNet.Artifacts.net8.0/
          fi
        continue-on-error: true
      
      # æ‰§è¡Œ net10.0 æ€§èƒ½æµ‹è¯•
      - name: Run benchmarks on net10.0
        run: |
          dotnet run --project WebApiClientCore.Benchmarks/WebApiClientCore.Benchmarks.csproj --configuration Release --framework net10.0 --no-build -- --filter '*' --exporters json --artifacts ./BenchmarkDotNet.Artifacts.net10.0
          if [ -d "BenchmarkDotNet.Artifacts/results" ]; then
            mkdir -p BenchmarkDotNet.Artifacts.net10.0
            cp -r BenchmarkDotNet.Artifacts/results BenchmarkDotNet.Artifacts.net10.0/
          fi
        continue-on-error: true
      
      # AOT æ€§èƒ½æµ‹è¯•ï¼ˆæš‚æ—¶ç¦ç”¨ï¼‰
      # åŸå› ï¼šBenchmarkDotNet 0.15.7 ä¾èµ– CommandLineParser å’Œåå°„ï¼Œæ— æ³•åœ¨ AOT ä¸‹è¿è¡Œ
      # é”™è¯¯ï¼šSystem.InvalidOperationException: Type BenchmarkDotNet.ConsoleArguments.CommandLineOptions appears to be immutable
      # ç­‰å¾… BenchmarkDotNet å®˜æ–¹å®Œå…¨æ”¯æŒ Native AOT åå†å¯ç”¨
      # 
      # - name: Build AOT Benchmark project
      #   run: dotnet publish WebApiClientCore.Benchmarks.Aot/WebApiClientCore.Benchmarks.Aot.csproj --configuration Release --output ./aot-publish
      #   continue-on-error: true
      # 
      # - name: Run AOT benchmarks on net10.0
      #   if: success()
      #   run: |
      #     cd WebApiClientCore.Benchmarks.Aot
      #     chmod +x ../aot-publish/WebApiClientCore.Benchmarks.Aot
      #     ../aot-publish/WebApiClientCore.Benchmarks.Aot --filter '*' --exporters json --artifacts ./BenchmarkDotNet.Artifacts.net10.0-aot
      #     # å¤åˆ¶ç»“æœåˆ°æ ¹ç›®å½•
      #     if [ -d "BenchmarkDotNet.Artifacts/results" ]; then
      #       mkdir -p ../BenchmarkDotNet.Artifacts.net10.0-aot
      #       cp -r BenchmarkDotNet.Artifacts/results ../BenchmarkDotNet.Artifacts.net10.0-aot/
      #     fi
      #     cd ..
      #   continue-on-error: true
      
      # æ”¶é›†æ€§èƒ½æµ‹è¯•ç»“æœ
      - name: List benchmark results
        if: always()
        run: |
          echo "=== Current Directory ==="
          pwd
          echo ""
          echo "=== Benchmark Results Directories ==="
          find . -name "BenchmarkDotNet.Artifacts*" -type d
          echo ""
          echo "=== All Result Files ==="
          find . -path "*/BenchmarkDotNet.Artifacts*/results/*" -type f
          echo ""
          echo "=== Checking for JSON results ==="
          find . -path "*/BenchmarkDotNet.Artifacts*/results/*.json" -type f | while read file; do
            echo "Found: $file"
            echo "Size: $(du -h "$file" | cut -f1)"
          done
          echo ""
          echo "=== Directory Tree ==="
          ls -la BenchmarkDotNet.Artifacts.* 2>/dev/null || echo "No BenchmarkDotNet.Artifacts.* directories found in root"
      
      # ç”Ÿæˆè¯¦ç»†çš„æ€§èƒ½å¯¹æ¯”æ‘˜è¦ï¼ˆåŒæ—¶è¾“å‡ºåˆ° Summary å’Œæ–‡ä»¶ï¼‰
      - name: Generate detailed benchmark summary
        if: always()
        run: |
          chmod +x .github/scripts/generate-benchmark-summary.sh
          
          # ç”Ÿæˆæ ‡é¢˜å’ŒåŸºæœ¬ä¿¡æ¯
          echo "## Performance Benchmark Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Benchmark execution completed. Download the artifact for detailed results." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æ‰§è¡Œæ±‡æ€»è„šæœ¬ï¼ŒåŒæ—¶è¾“å‡ºåˆ° Summary å’Œæ–‡ä»¶
          .github/scripts/generate-benchmark-summary.sh | tee benchmark-summary.md >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“¦ Download Instructions" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Scroll to the bottom of this page" >> $GITHUB_STEP_SUMMARY
          echo "2. Find the 'Artifacts' section" >> $GITHUB_STEP_SUMMARY
          echo "3. Click on **benchmark-results** to download" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“ Artifact Contents" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **benchmark-summary.md** - Complete multi-framework comparison (same as above)" >> $GITHUB_STEP_SUMMARY
          echo "- **BenchmarkDotNet.Artifacts.netcoreapp3.1/results/** - .NET Core 3.1 detailed results" >> $GITHUB_STEP_SUMMARY
          echo "- **BenchmarkDotNet.Artifacts.net5.0/results/** - .NET 5.0 detailed results" >> $GITHUB_STEP_SUMMARY
          echo "- **BenchmarkDotNet.Artifacts.net8.0/results/** - .NET 8.0 detailed results" >> $GITHUB_STEP_SUMMARY
          echo "- **BenchmarkDotNet.Artifacts.net10.0/results/** - .NET 10.0 detailed results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âš ï¸ AOT Benchmark Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Native AOT benchmark is currently disabled because:" >> $GITHUB_STEP_SUMMARY
          echo "- BenchmarkDotNet 0.15.7 uses reflection and runtime code generation" >> $GITHUB_STEP_SUMMARY
          echo "- CommandLineParser library is not AOT-compatible" >> $GITHUB_STEP_SUMMARY
          echo "- Waiting for official Native AOT support from BenchmarkDotNet" >> $GITHUB_STEP_SUMMARY
      
      # ä¸Šä¼ æ€§èƒ½æµ‹è¯•æŠ¥å‘Šï¼ˆåœ¨æ±‡æ€»ç”Ÿæˆä¹‹åï¼‰
      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: benchmark-results
          path: |
            BenchmarkDotNet.Artifacts.*/results/**/*
            WebApiClientCore.Benchmarks.Aot/BenchmarkDotNet.Artifacts.*/results/**/*
            WebApiClientCore.Benchmarks/results/**/*
            benchmark-summary.md
          retention-days: 30
